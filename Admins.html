<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Migrar Google → Manual</title>

<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

<style>
    body {
        background: #111;
        color: white;
        font-family: Arial;
        padding: 20px;
    }
    .box {
        background: #1f1f1f;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 12px;
        border-left: 5px solid #ff0080;
    }
    #migrarBtn {
        background: #ff0080;
        padding: 12px;
        width: 100%;
        border: none;
        color: #fff;
        font-size: 18px;
        border-radius: 10px;
        cursor: pointer;
        margin-top: 15px;
    }
</style>
</head>
<body>

<h2>Migrar cuenta Google → Manual</h2>

<p>1️⃣ Selecciona un usuario Google<br>  
2️⃣ Ingresa el nuevo nombre manual<br>  
3️⃣ Se migrarán los datos del UID al usuario manual</p>

<div id="userList">Cargando usuarios...</div>

<input id="newUser" type="text" placeholder="Nuevo nombre manual" style="width:100%;padding:12px;border-radius:10px;border:none;margin-top:10px;">

<button id="migrarBtn">Migrar de Google a Manual</button>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyCr1-2dIqgxoXBTKYgSusnUZorUICX2Too",
    authDomain: "chatglobal-e9370.firebaseapp.com",
    databaseURL: "https://chatglobal-e9370-default-rtdb.firebaseio.com",
    projectId: "chatglobal-e9370",
    storageBucket: "chatglobal-e9370.firebasestorage.app",
    messagingSenderId: "382420208590",
    appId: "1:382420208590:web:9425fa28c8cdf669adb99f"
};

firebase.initializeApp(firebaseConfig);

const db = firebase.database();
const auth = firebase.auth();

const usersRef = db.ref("users");
const uidMapRef = db.ref("uid_map");
const container = document.getElementById("userList");

// ---------------------------
// Listar usuarios con Google
// ---------------------------
usersRef.on("value", snap => {
    container.innerHTML = "";
    const users = snap.val();

    Object.entries(users).forEach(([key, data]) => {
        if (!data.provider || !data.provider.includes("google")) return;

        const box = document.createElement("div");
        box.className = "box";
        box.innerHTML = `
            <label>
                <input type="radio" name="googleUser" value="${key}">
                <strong>${key}</strong><br>
                <small>Email: ${data.email}</small>
            </label>
        `;
        container.appendChild(box);
    });
});

// ---------------------------
// Migrar Google → Manual
// ---------------------------
async function migrarGoogleAManual(uidGoogle, nuevoUsuario) {
    // Obtener data del Google UID
    const snap = await usersRef.child(uidGoogle).once("value");
    const dataGoogle = snap.val();

    if (!dataGoogle) {
        alert("Error: el usuario Google no existe.");
        return;
    }

    // Crear usuario manual con los mismos datos
    await usersRef.child(nuevoUsuario).set({
        ...dataGoogle,
        provider: "manual",
        uid: null
    });

    // Borrar mapeo
    await uidMapRef.child(uidGoogle).remove();

    // Borrar cuenta Google
    await usersRef.child(uidGoogle).remove();

    alert("Migración inversa completada!");
}

// ---------------------------
// Botón migrar
// ---------------------------
document.getElementById("migrarBtn").onclick = () => {
    const googleUser = document.querySelector("input[name='googleUser']:checked");
    const nuevoUser = document.getElementById("newUser").value.trim();

    if (!googleUser) return alert("Selecciona un usuario Google.");
    if (!nuevoUser) return alert("Escribe un nombre manual.");

    migrarGoogleAManual(googleUser.value, nuevoUser);
};
</script>

</body>
</html>

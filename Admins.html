<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Migrar Usuarios a Google</title>

<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

<style>
    body {
        background: #111;
        color: white;
        font-family: Arial;
        padding: 20px;
    }
    .box {
        background: #1f1f1f;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 12px;
        border-left: 5px solid #2af599;
    }
    #migrarBtn {
        background: #2af599;
        padding: 12px;
        width: 100%;
        border: none;
        color: #111;
        font-size: 18px;
        border-radius: 10px;
        cursor: pointer;
        margin-top: 15px;
    }
    #migrarBtn:hover {
        background: #23cc81;
    }
</style>
</head>
<body>

<h2>Migrar Usuario Manual → Google</h2>

<p>1️⃣ Selecciona un usuario manual<br>  
2️⃣ Inicia sesión con Google<br>  
3️⃣ Automáticamente se migrarán los datos a la nueva cuenta Google</p>

<div id="userList">Cargando usuarios...</div>

<button id="migrarBtn">Migrar usuario seleccionado a Google</button>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyCr1-2dIqgxoXBTKYgSusnUZorUICX2Too",
    authDomain: "chatglobal-e9370.firebaseapp.com",
    databaseURL: "https://chatglobal-e9370-default-rtdb.firebaseio.com",
    projectId: "chatglobal-e9370",
    storageBucket: "chatglobal-e9370.firebasestorage.app",
    messagingSenderId: "382420208590",
    appId: "1:382420208590:web:9425fa28c8cdf669adb99f"
};

firebase.initializeApp(firebaseConfig);

const db = firebase.database();
const auth = firebase.auth();

const usersRef = db.ref("users");
const uidMapRef = db.ref("uid_map");

const container = document.getElementById("userList");

// ---------------------------
// Cargar usuarios manuales
// ---------------------------
usersRef.on("value", snap => {
    container.innerHTML = "";
    const users = snap.val();

    if (!users) {
        container.innerHTML = "<p>No hay usuarios registrados.</p>";
        return;
    }

    Object.entries(users).forEach(([username, data]) => {

        // Solo usuarios manuales
        if (data.provider === "google") return;

        const box = document.createElement("div");
        box.className = "box";
        box.innerHTML = `
            <label>
                <input type="radio" name="manualUser" value="${username}">
                <strong>${username}</strong><br>
                <small>Email: ${data.email ?? "sin email"}</small>
            </label>
        `;
        container.appendChild(box);
    });
});

// ---------------------------
// Migrar datos
// ---------------------------
async function migrarCuenta(manualUser, googleUID) {
    // 1. Obtener data del usuario manual
    const snap = await usersRef.child(manualUser).once("value");
    const manualData = snap.val();

    if (!manualData) {
        alert("Error: usuario manual no existe.");
        return;
    }

    // 2. Guardar el data en la cuenta Google
    await usersRef.child(googleUID).update(manualData);

    // 3. Borrar uid_map si tenía
    if (manualData.uid) {
        await uidMapRef.child(manualData.uid).remove();
    }

    // 4. Borrar el usuario manual original
    await usersRef.child(manualUser).remove();

    alert("Migración completada correctamente.");
}

// ---------------------------
// Botón para iniciar migración
// ---------------------------
document.getElementById("migrarBtn").onclick = () => {
    const manualUser = document.querySelector("input[name='manualUser']:checked");

    if (!manualUser) {
        alert("Selecciona un usuario manual.");
        return;
    }

    const userName = manualUser.value;

    const provider = new firebase.auth.GoogleAuthProvider();

    // Abrir login Google
    auth.signInWithPopup(provider)
        .then(result => {
            const googleUID = result.user.uid;

            // Ejecutar migración
            migrarCuenta(userName, googleUID);
        })
        .catch(err => {
            console.error(err);
            alert("Error al iniciar sesión con Google.");
        });
};
</script>

</body>
</html>
